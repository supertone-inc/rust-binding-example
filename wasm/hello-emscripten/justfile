EMSDK_DIR := absolute_path("build/_deps/emsdk-src")
HELLO_CPP_DIR := absolute_path("../../cpp/hello")

build:
    #!/usr/bin/env bash
    set -e

    cmake \
        -S . \
        -B build \
        -D HELLO_INCLUDE_DIR={{HELLO_CPP_DIR}}/hello/include \
        -D HELLO_LIB_DIR={{HELLO_CPP_DIR}}/hello/staticlib

    export CARGO_BUILD_TARGET=wasm32-unknown-emscripten
    rustup target add ${CARGO_BUILD_TARGET}
    source {{EMSDK_DIR}}/emsdk_env.sh
    just {{HELLO_CPP_DIR}}/build-staticlib

    cmake --build build --clean-first
    cmake --install build --prefix hello

test: build
    #!/usr/bin/env bash
    set -e

    cd tests
    npm install
    npm test

test-quick:
    #!/usr/bin/env bash
    set -e

    cd tests
    npm test
